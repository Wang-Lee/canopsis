#!/bin/bash

NAME="canolibs"
VERSION=0.7
RELEASE=0
DESCRIPTION=""
REQUIRES="canohome python python-libs"

NO_ARCH=true
NO_DIST=true
NO_DISTVERS=true

function pre_install(){
	echo "Pre-install $NAME $VERSION-$RELEASE ..."
	check_code $?

	if [ -e $VARLIB_PATH/rabbitmq-server-conf ]
	then
		cp $PREFIX/etc/amqp.conf{,.bak}
	fi

	if [ -e $VARLIB_PATH/mongodb-conf ]
	then
		cp $PREFIX/etc/cstorage.conf{,.bak}
	fi
}

function post_install(){
	echo "-- Update python-logging.conf"
	sed -i s:@PREFIX@:$PREFIX:g $PREFIX/etc/python-logging.conf
	check_code $? 

	echo "-- Create logdir for engines"
	mkdir -p $PREFIX/var/log/engines
	check_code $?

	echo "-- Update canopsis service"
	sed -i s:@PREFIX@:$PREFIX:g $PREFIX/etc/init.d/canopsis
	check_code $?
	sed -i s:@USER@:$HUSER:g $PREFIX/etc/init.d/canopsis
	check_code $?

	add_message "snmp2amqp needs the following in your sudoers file (/etc/sudoers):"
	add_message "    Defaults:$HUSER env_keep += \"HOME LD_LIBRARY_PATH PYTHONPATH\"" 
	add_message "    $HUSER ALL=NOPASSWD: $PREFIX/bin/python $PREFIX/opt/$NAME/$NAME.py" 

	echo "-- Fix permissions"
	chown -R $HUSER:$HGROUP $PREFIX/etc
	check_code $?

	echo "-- Save old credentials for RabbitMQ and MongoDB"

	if [ -e $VARLIB_PATH/rabbitmq-server-conf ]
	then
		rabbit_user=`su - $HUSER -c "$PREFIX/bin/initool get $PREFIX/etc/amqp.conf.bak master userid"`
		rabbit_pass=`su - $HUSER -c "$PREFIX/bin/initool get $PREFIX/etc/amqp.conf.bak master password"`

		su - $HUSER -c "$PREFIX/bin/initool set $PREFIX/etc/amqp.conf master userid $rabbit_user"
		su - $HUSER -c "$PREFIX/bin/initool set $PREFIX/etc/amqp.conf master password $rabbit_pass"

		rm $PREFIX/etc/amqp.conf.bak
	fi

	if [ -e $VARLIB_PATH/mongodb-conf ]
	then
		mongo_user=`su - $HUSER -c "$PREFIX/bin/initool get $PREFIX/etc/cstorage.conf.bak master userid"`
		mongo_pass=`su - $HUSER -c "$PREFIX/bin/initool get $PREFIX/etc/cstorage.conf.bak master password"`

		su - $HUSER -c "$PREFIX/bin/initool set $PREFIX/etc/cstorage.conf master userid $mongo_user"
		su - $HUSER -c "$PREFIX/bin/initool set $PREFIX/etc/cstorage.conf master password $mongo_pass"

		rm $PREFIX/etc/cstorage.conf.bak
	fi
}

function pre_remove(){
	echo "Pre-remove $NAME $VERSION-$RELEASE ..."
	check_code $?
}

function post_remove(){
	echo "Post-remove $NAME $VERSION-$RELEASE ..."
	check_code $?
}

function pre_update(){
	echo "Pre-update $NAME $VERSION-$RELEASE ..."
	echo " + Clean old unittests"
	rm -Rf $PREFIX/lib/canolibs/unittest/*
}

function post_update(){
	echo "-- Update python-logging.conf"
	sed -i s:@PREFIX@:$PREFIX:g $PREFIX/etc/python-logging.conf
	check_code $? 

	echo "-- Create logdir for engines"
	mkdir -p $PREFIX/var/log/engines
	check_code $?
}

function purge(){
	echo "Purge $NAME $VERSION-$RELEASE ..."
	check_code $?
}
